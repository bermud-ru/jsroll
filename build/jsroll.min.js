/**
 * @app jsroll.js
 * @category RIA (Rich Internet Application) / (SPA) Single-page Application
 *
 * Функции-классы RIA / SPA
 * @author Андрей Новиков <andrey@novikov.be>
 * @data 01/01/2016
 */

(function(h,d){"use strict";var f=("onload" in new XMLHttpRequest())?XMLHttpRequest:XDomainRequest;var a=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(o){var n=Math.random()*16|0,g=o=="x"?n:(n&3|8);return g.toString(16)})};h.uuid=a;var e=function(n){var o=/[?&]([^=#]+)=([^&#]*)/g,r={},g;try{while(g=o.exec((n||h.location.search))){if((m1=decodeURIComponent(g[1]))&&(m2=decodeURIComponent(g[2]))&&!r.hasOwnProperty(m1)){r[m1]=m2}}}catch(q){return null}return r};h.location.params=e;function l(o){var n=!!(history.pushState)?1:0;var g=o;return{root:g,rt:[],itv:0,base:n?window.location.pathname+window.location.search:"",clr:function(p){return p.toString().replace(/\/$/,"").replace(/^\//,"")},frgm:n?function(){var p=this.clr(decodeURI(location.pathname+location.search)).replace(/\?(.*)$/,"");return this.clr(this.root!="/"?p.replace(this.root,""):p)}:function(){var p=window.location.href.match(/#(.*)$/);return p?this.clr(p[1]):""},add:function(q,p){if(typeof q=="function"){p=q;q=""}this.rt.push({re:q,handler:p});this.rt=this.rt.sort(function(s,r){if(s.re.toString().length<r.re.toString().length){return 1}if(s.re.toString().length>r.re.toString().length){return -1}return 0});return this},rm:function(q){for(var p in this.rt){if(this.rt[p].handler===q||this.rt[p].re.toString()===q.toString()){this.rt.splice(p,1);return this}}return this},chk:function(q){var s=q||this.frgm();for(var r in this.rt){var p=s.match(this.rt[r].re);if(p){p.shift();this.rt[r].handler.apply({},p);return this}}return this},lsn:function(){var q=this,r=q.frgm(),p=function(){if(r!==q.frgm()){r=q.frgm();q.chk(r)}return q};clearInterval(q.itv);q.itv=setInterval(p,50);return q},set:n?function(p){history.pushState(null,null,this.root+this.clr((p||"")));return this}:function(p){window.location.href=window.location.href.replace(/#(.*)$/,"")+"#"+(p||"");return this}}}h.router=l("/");function b(){var g=function(p,o){return h.dispatchEvent(new CustomEvent(p,{detail:o}))},n=function(q,p,o){return h.addEventListener(q,p,!!o?o:false)};h.onbeforeunload=function(o){o.preventDefault()};h.onclickhandler=function(o){if(h.eventhandler.onclick(o)){o.preventDefault();o.stopPropagation()}};n("onbeforeunload",h.onbeforeunload.bind(h),false);n("click",h.onclickhandler.bind(h),true);return{set onbeforeunload(o){h.onbeforeunload=o},onclick:function(o){return false},event:g,bind:n}}h.eventhandler=b();function m(){var g=new f();if(!g){return null}if(!g.hasOwnProperty("ref")){g.ref={}}g.request=function(u,o,q,t,n){var s="";for(var p in arguments){s+=arguments[p].toString().replace(/(\.|\/|\-)/g,"_")}if(g.ref.hasOwnProperty(s)&&!!g.ref[s].isLoad){return g.ref[s]}var r=new m();r.isLoad=false;r.open(u,o,(typeof q!=="undefined"?q:true),t,n);r.send(data||null);r.id=s;return g.ref[s]=r};g.result=function(n){g.onload=function(o){this.isLoad=true;return n.call(this,o)};return this};g.process=function(n){g.onreadystatechange=function(o){return n.call(this,o)};return this};return g}h.xhr=m();var k=function(g,o,n){k.src[o]=new f();k.src[o].overrideMimeType("text/javascript; charset=utf-8");if(n){k.src[o].onload=function(r){var q=j.cache[o]=c(this.responseText);for(var p in k.pool[o]){k.pool[o][p].cb.call(this,(k.pool[o][p].data?q(k.pool[o][p].data):q))}k.pool[o]=d}}k.src[o].open("GET",g,n);k.src[o].send(null);if(!n){return(k.src[o].status!=200?"":k.src[o].responseText)}return""},c=function(g){return new Function("_e","var p=[],print=function(){p.push.apply(p,arguments);};with(_e){p.push('"+g.replace(/[\r\t\n]/g," ").split("{%").join("\t").replace(/((^|%})[^\t]*)'/g,"$1\r").replace(/\t=(.*?)%}/g,"',$1,'").split("\t").join("');").split("%}").join("p.push('").split("\r").join("\\'")+"');}return p.join('');")},j=function j(t,r,n){var g=t.match(/^(?:https?:\/\/)?(?:(?:[\w]+\.)(?:\.?[\w]{2,})+)?([\/\w]+)(\.[\w]+)/i);try{if(g){t=t.replace(/(\.|\/|\-)/g,"");if(typeof n==="function"){if(typeof k.pool[t]==="undefined"){k.pool[t]=[{data:r,cb:n}];return k(g.input,t,true)}else{var o=k.pool[t];o.push({data:r,cb:n});return""}}else{j.cache[t]=j.cache[t]||c(k(g.input,t,false))}}var q=!/[^\w\-\.]/.test(t)?j.cache[t]=j.cache[t]||j(h.document.getElementById(t).innerHTML):c(t);var p=r?q(r):q;if(typeof(n)==="function"){return n.call(j,p)}else{return p}}catch(s){console.error(s);return""}};k.src=[];k.pool=[];j.cache={};h.tmpl=j;var i=function(g){var g=g||h.localStorage;try{g.setItem("test","1");g.removeItem("test")}catch(n){return{p:[],setItem:function(o,p){this.p.push(o);this[o]=p},getItem:function(o){if(this.hasOwnProperty(o)){return this[o]}return null},removeItem:function(o){if(this.hasOwnProperty(o)){delete this.p[o];delete this[o]}},clear:function(){this.p.map(function(o){delete this[o]});this.p=[]}}}return g};h.storage=i()}(window));